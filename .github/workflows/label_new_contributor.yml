name: Label New Contributors

# Written with ChatGPT: https://chat.openai.com/share/3777ceb1-d722-4705-bacd-ba3f04b387be

on: pull_request

jobs:
  label-and-report-new-contributor:
    runs-on: ubuntu-latest
    # Don't run on forks, where we wouldn't have permissions to add the label anyway.
    if: github.repository == 'leanprover-community/mathlib4'
    permissions:
      checks: write
      pull-requests: write
      contents: read
    steps:
      - name: Label PR and report count
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.sender.login
            const { owner, repo } = context.repo;
            const opts = github.rest.issues.listForRepo.endpoint.merge({
              ...context.issue,
              owner,
              repo,
              creator,
              state: 'closed'
            })
            const issues = await github.paginate(opts)
            const pullRequestCount = issues.length;

            // Determine if the creator has 5 or fewer pull requests
            if (0 <= pullRequestCount) {
              // Add the "new-contributor" label to the current pull request
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner,
                repo,
                labels: ['new-contributor']
              });
            }

            // Create a check run with a message about the PR count by this author
            const message = `Found ${pullRequestCount} PRs by ${creator}.`;
            await github.rest.checks.create({
              owner,
              repo,
              name: 'New Contributor Check',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'neutral',
              output: {
                title: message,
                summary: message,
              },
            });

      - name: Post a comment on the PR from fork
        if: ${{ github.event.pull_request.head.repo.full_name != 'leanprover-community/mathlib4' }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "Thank you for opening a PR from your fork! `Mathlib`'s CI is designed to work from a branch, though, rather than from a fork: please, ask for permission to push to non-master branches on Zulip, close this PR and re-open it as a branch!"
            })

      - name: Post a comment on the PR from branch
        if: ${{ github.event.pull_request.head.repo.full_name == 'leanprover-community/mathlib4' }}
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "From ${{ github.repository }}"
            })
