/-
Copyright (c) 2024 Mitchell Lee. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Mitchell Lee
-/
import Mathlib.RingTheory.TensorProduct.Basic

/-! # Vanishing of elements in a tensor product of two modules

Let $M$ and $N$ be modules over a commutative ring $R$. Recall that every element of $M \otimes N$
can be written as a finite sum $\sum_{i} m_i \otimes n_i$ of pure tensors
(`TensorProduct.exists_finset`). We would like to determine under what circumstances such an
expression vanishes.

Let us say that an expression $\sum_i m_i \otimes n_i$ in $M \otimes N$ *vanishes trivially*
(where $i$ ranges over some finite index type $\iota$) if there exist a finite index type $\kappa$,
elements $(y_j)_{j \in \kappa}$ of $N$, and elements $(a_{ij})_{i \in \iota, j \in \kappa}$ of $R$
such that for all $i$,
\[n_i = \sum_j a_{ij} y_j\]
and for all $j$,
\[\sum_{i} a_{ij} m_i = 0.\]
(The terminology "trivial" comes from [Stacks 00HK](https://stacks.math.columbia.edu/tag/00HK).)
It is not difficult to show that if $\sum_i m_i \otimes n_i$ vanishes trivially, then it vanishes;
that is, $\sum_i m_i \otimes n_i = 0$.

The *equational criterion for vanishing*
([A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term]) states
that if the elements $m_i$ generate the module $M$, then $\sum_i m_i \otimes n_i = 0$ if and only if
the expression $\sum_i m_i \otimes n_i$ vanishes trivially.

We also prove the following generalization. If the submodule $M' \subseteq M$ generated by
the $m_i$ satisfies the property that the induced map $M' \otimes N \to M \otimes N$ is injective,
then $\sum_i m_i \otimes n_i = 0$ if and only if the expression $\sum_i m_i \otimes n_i$ vanishes
trivially. (This fact is used in the case $M = R$ to prove the equational criterion for flatness
`Module.Flat.relation_trivial_of_flat`.)

Conversely, suppose that for every equation $\sum_i m_i \otimes n_i = 0$, the
expression $\sum_i m_i \otimes n_i$ vanishes trivially. Then the induced map
$M' \otimes N \to M \otimes N$ is injective for every submodule $M' \subseteq M$.

## References

* [A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term]

## TODO

* Prove the same theorems with $M$ and $N$ swapped.

-/

universe u

variable (R : Type u) [CommRing R]
variable {M : Type u} [AddCommGroup M] [Module R M]
variable {N : Type u} [AddCommGroup N] [Module R N]

open Classical DirectSum LinearMap Function Submodule
open scoped BigOperators

namespace TensorProduct

variable {ι : Type u} [Fintype ι] (m : ι → M) (n : ι → N)

/-- The proposition that the expression $\sum_i m_i \otimes n_i$ in $M \otimes N$
*vanishes trivially*. That is, there exist a finite index type $\kappa$,
elements $(y_j)_{j \in \kappa}$ of $N$, and elements $(a_{ij})_{i \in \iota, j \in \kappa}$ of $R$
such that for all $i$,
\[n_i = \sum_j a_{ij} y_j\]
and for all $j$,
\[\sum_{i} a_{ij} m_i = 0.\] -/
abbrev VanishesTrivially : Prop :=
  ∃ (κ : Type u) (_ : Fintype κ) (a : ι → κ → R) (y : κ → N),
    (∀ i, n i = ∑ j, a i j • y j) ∧ ∀ j, ∑ i, a i j • m i = 0

/-- **Equational criterion for vanishing**,
[A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term],
backward direction. If the expression $\sum_i m_i \otimes n_i$ vanishes trivially, then it vanishes.
That is, $\sum_i m_i \otimes n_i = 0$. -/
theorem sum_tmul_eq_zero_of_vanishesTrivially (hmn : VanishesTrivially R m n) :
    ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N) := by
  obtain ⟨κ, _, a, y, h₁, h₂⟩ := hmn
  simp_rw [h₁, tmul_sum, tmul_smul]
  rw [Finset.sum_comm]
  simp_rw [← tmul_smul, ← smul_tmul, ← sum_tmul, h₂, zero_tmul, Finset.sum_const_zero]

/-- **Equational criterion for vanishing**,
[A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term],
forward direction. Assume that the $m_i$ generate $M$. If the expression $\sum_i m_i \otimes n_i$
vanishes, then it vanishes trivially. -/
theorem vanishesTrivially_of_sum_tmul_eq_zero (hm : Submodule.span R (Set.range m) = ⊤)
    (hmn : ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N)) : VanishesTrivially R m n := by
  sorry

/-- **Equational criterion for vanishing**,
[A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term].
Assume that the $m_i$ generate $M$. Then the expression $\sum_i m_i \otimes n_i$ vanishes
trivially if and only if it vanishes. -/
theorem vanishesTrivially_iff_sum_tmul_eq_zero (hm : Submodule.span R (Set.range m) = ⊤) :
    VanishesTrivially R m n ↔ ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N) := by
  sorry

/-- **Equational criterion for vanishing**,
[A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term],
forward direction. Assume that the $m_i$ generate a submodule $M' \subseteq M$ such that the map
$M' \otimes N \to M \otimes N$ is injective. If the expression $\sum_i m_i \otimes n_i$ vanishes,
then it vanishes trivially. -/
theorem vanishesTrivially_of_sum_tmul_eq_zero_of_rTensor_injective
    (hm : Injective (rTensor N (span R (Set.range m)).subtype))
    (hmn : ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N)) : VanishesTrivially R m n := by
  sorry

/-- **Equational criterion for vanishing**,
[A. Altman and S. Kleiman, *A term of commutative algebra* (Lemma 8.16)][altman2012term].
Assume that the $m_i$ generate a submodule $M' \subseteq M$ such that the map
$M' \otimes N \to M \otimes N$ is injective. Then the expression $\sum_i m_i \otimes n_i$ vanishes
trivially if and only if it vanishes. -/
theorem vanishesTrivially_iff_sum_tmul_eq_zero_of_rTensor_injective
    (hm : Injective (rTensor N (span R (Set.range m)).subtype)) :
    VanishesTrivially R m n ↔ ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N) := by
  sorry

/-- Assume that every expression $\sum_i m_i \otimes n_i$ which vanishes also vanishes trivially.
Then, for every submodule $M' \subseteq M$, the map $M' \otimes N \to M \otimes N$ is injective. -/
theorem rTensor_injective_of_forall_vanishesTrivially
    (hMN : ∀ {ι : Type u} [Fintype ι] (m : ι → M) (n : ι → N),
      ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N) → VanishesTrivially R m n)
    (M' : Submodule R M) : Injective (rTensor N M'.subtype) := by
  sorry

/-- Every expression $\sum_i m_i \otimes n_i$ which vanishes also vanishes trivially if and only if
for every submodule $M' \subseteq M$, the map $M' \otimes N \to M \otimes N$ is injective. -/
theorem forall_rTensor_injective_iff_forall_vanishesTrivially :
    (∀ {ι : Type u} [Fintype ι] (m : ι → M) (n : ι → N),
      ∑ i, m i ⊗ₜ n i = (0 : M ⊗[R] N) → VanishesTrivially R m n) ↔
    ∀ M' : Submodule R M, Injective (rTensor N M'.subtype) := by
  sorry

end TensorProduct
