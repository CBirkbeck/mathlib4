/-
Copyright (c) 2024 Christopher Hoskin. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Christopher Hoskin
-/

import Mathlib.Algebra.Module.Submodule.Lattice
import Mathlib.Order.CompleteSublattice
import Mathlib.Algebra.Algebra.Subalgebra.Basic
import Mathlib.LinearAlgebra.Basis.Basic

/-!
# Nest algebras
-/

variable (R M N : Type*)

variable [CommSemiring R] [AddCommMonoid M] [Module R M]

instance test : CompleteLattice (Submodule R M) := Submodule.completeLattice

--variable (N : CompleteSublattice (Submodule R M)) [LinearOrder N]

/--
A nest is a totally ordered set of subspaces which is closed under intersection and span and
contains the trivial an universal subspaces.
-/
structure IsNest (N : CompleteSublattice (Submodule R M)) [LinearOrder N] where
  mem_bot: ⊥ ∈ N
  mem_top: ⊤ ∈ N

variable {ι : Type*} [LinearOrder ι] (bm : Basis ι R M)

#check Set.image_subset

variable {R} {M}

def csh : ι →o Submodule R M where
  toFun := fun i ↦ sInf {p | ⇑bm '' Set.Iio i ⊆ ↑p}
  monotone' := fun _ _ hab => sInf_le_sInf (fun _ hn => subset_trans (Set.image_subset _
    (Set.Iio_subset_Iio hab)) hn)

def csh2 : ι →o Submodule R M := ⟨fun i ↦ sInf {p | bm '' Set.Iio i ⊆ ↑p},
  fun _ _ hab => sInf_le_sInf (fun _ hn => subset_trans (Set.image_subset _
  (Set.Iio_subset_Iio hab)) hn)⟩

lemma test' : SupClosed (Set.range (csh bm)) := by
  apply supClosed_range

lemma SupClosed.insert_top {α : Type*} [SemilatticeSup α] [OrderTop α] {s : Set α}
    (h : SupClosed s) :
  SupClosed (insert (⊤ : α) s) := by
  rw [SupClosed]
  aesop

lemma SupClosed.insert_bot {α : Type*} [SemilatticeSup α] [OrderBot α] {s : Set α}
    (h : SupClosed s) :
  SupClosed (insert (⊥ : α) s) := by
  rw [SupClosed]
  aesop


/--
The nest generated by a linearly ordered basis
-/
def Basis.toNest : Sublattice (Submodule R M) where
  carrier := {⊤} ∪ Set.range (⟨fun i ↦ sInf {p | bm '' Set.Iio i ⊆ ↑p},
  fun _ _ hab => sInf_le_sInf (fun _ hn => subset_trans (Set.image_subset _
  (Set.Iio_subset_Iio hab)) hn)⟩ : ι →o Submodule R M )
  supClosed' := SupClosed.insert_top (supClosed_range _)
  infClosed' := sorry

/-
structure nest extends  CompleteSublattice (Submodule R M) where
  mem_bot: ⊥ ∈ carrier
  mem_top: ⊤ ∈ carrier
  lo: LinearOrder carrier
-/

/--
The nest algebra of a nest
-/
def NestAlg (N : CompleteSublattice (Submodule R M)) : Subalgebra R (M →ₗ[R] M) where
  carrier := { T | ∀ (n : N), T '' n ⊆ n}
  add_mem' S T := by
    intro n x hx
    obtain ⟨y, ⟨hy₁, hy₂⟩⟩ := hx
    rw [← hy₂, LinearMap.add_apply]
    exact AddMemClass.add_mem (S _ (Set.mem_image_of_mem _ hy₁))  (T _ (Set.mem_image_of_mem _ hy₁))
  mul_mem' S T := by
    intro n h hx
    obtain ⟨y, hy₁, hy₂⟩ := hx
    rw [← hy₂, LinearMap.mul_apply]
    exact S _ (Set.mem_image_of_mem _ (T _ (Set.mem_image_of_mem _ hy₁)))
  one_mem' := by
    intro n
    simp only [LinearMap.one_apply, Set.image_id', subset_refl]
  zero_mem' := by
    intro n
    simp only [LinearMap.zero_apply, Set.image_subset_iff, SetLike.mem_coe, Submodule.zero_mem,
      Set.preimage_const_of_mem, Set.subset_univ]
  algebraMap_mem' := by
    intro r n x hx
    obtain ⟨y, hy₁, hy₂⟩ := hx
    rw [← hy₂, Module.algebraMap_end_apply]
    exact SMulMemClass.smul_mem _ hy₁
